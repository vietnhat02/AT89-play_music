C51 COMPILER V9.01   I2C                                                                   12/07/2023 07:54:50 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN i2c.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE i2c.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include"i2c.h"
   2          /*******************************************************************************
   3          * 函数名         : Delay1us()
   4          * 函数功能                 : 延时
   5          * 输入           : 无
   6          * 输出           : 无
   7          *******************************************************************************/
   8          
   9          void Delay10us()
  10          {
  11   1              unsigned char a,b;
  12   1              for(b=1;b>0;b--)
  13   1                      for(a=2;a>0;a--);
  14   1      
  15   1      }
  16          /*******************************************************************************
  17          * 函数名         : I2cStart()
  18          * 函数功能                 : 起始信号：在SCL时钟信号在高电平期间SDA信号产生一个下降沿
  19          * 输入           : 无
  20          * 输出           : 无
  21          * 备注           : 起始之后SDA和SCL都为0
  22          *******************************************************************************/
  23          
  24          void I2cStart()
  25          {
  26   1              SDA=1;
  27   1              Delay10us();
  28   1              SCL=1;
  29   1              Delay10us();//建立时间是SDA保持时间>4.7us
  30   1              SDA=0;
  31   1              Delay10us();//保持时间是>4us
  32   1              SCL=0;                  
  33   1              Delay10us();            
  34   1      }
  35          /*******************************************************************************
  36          * 函数名         : I2cStop()
  37          * 函数功能                 : 终止信号：在SCL时钟信号高电平期间SDA信号产生一个上升沿
  38          * 输入           : 无
  39          * 输出           : 无
  40          * 备注           : 结束之后保持SDA和SCL都为1；表示总线空闲
  41          *******************************************************************************/
  42          
  43          void I2cStop()
  44          {
  45   1              SDA=0;
  46   1              Delay10us();
  47   1              SCL=1;
  48   1              Delay10us();//建立时间大于4.7us
  49   1              SDA=1;
  50   1              Delay10us();            
  51   1      }
  52          /*******************************************************************************
  53          * 函数名         : I2cSendByte(unsigned char num)
  54          * 函数功能                 : 通过I2C发送一个字节。在SCL时钟信号高电平期间，保持发送信号SDA保持稳定
  55          * 输入           : num
C51 COMPILER V9.01   I2C                                                                   12/07/2023 07:54:50 PAGE 2   

  56          * 输出           : 0或1。发送成功返回1，发送失败返回0
  57          * 备注           : 发送完一个字节SCL=0,SDA=1
  58          *******************************************************************************/
  59          
  60          unsigned char I2cSendByte(unsigned char dat)
  61          {
  62   1              unsigned char a=0,b=0;//最大255，一个机器周期为1us，最大延时255us。             
  63   1              for(a=0;a<8;a++)//要发送8位，从最高位开始
  64   1              {
  65   2                      SDA=dat>>7;      //起始信号之后SCL=0，所以可以直接改变SDA信号
  66   2                      dat=dat<<1;
  67   2                      Delay10us();
  68   2                      SCL=1;
  69   2                      Delay10us();//建立时间>4.7us
  70   2                      SCL=0;
  71   2                      Delay10us();//时间大于4us               
  72   2              }
  73   1              SDA=1;
  74   1              Delay10us();
  75   1              SCL=1;
  76   1              while(SDA)//等待应答，也就是等待从设备把SDA拉低
  77   1              {
  78   2                      b++;
  79   2                      if(b>200)        //如果超过2000us没有应答发送失败，或者为非应答，表示接收结束
  80   2                      {
  81   3                              SCL=0;
  82   3                              Delay10us();
  83   3                              return 0;
  84   3                      }
  85   2              }
  86   1              SCL=0;
  87   1              Delay10us();
  88   1              return 1;               
  89   1      }
  90          /*******************************************************************************
  91          * 函数名         : I2cReadByte()
  92          * 函数功能                 : 使用I2c读取一个字节
  93          * 输入           : 无
  94          * 输出           : dat
  95          * 备注           : 接收完一个字节SCL=0,SDA=1.
  96          *******************************************************************************/
  97          
  98          unsigned char I2cReadByte()
  99          {
 100   1              unsigned char a=0,dat=0;
 101   1              SDA=1;                  //起始和发送一个字节之后SCL都是0
 102   1              Delay10us();
 103   1              for(a=0;a<8;a++)//接收8个字节
 104   1              {
 105   2                      SCL=1;
 106   2                      Delay10us();
 107   2                      dat<<=1;
 108   2                      dat|=SDA;
 109   2                      Delay10us();
 110   2                      SCL=0;
 111   2                      Delay10us();
 112   2              }
 113   1              return dat;             
 114   1      }
 115          /*******************************************************************************
 116          * 函数名         : I2cReadRespon()
 117          * 函数功能                 : 接收完一个字节之后产生应答，以便接着接收下一个字节
C51 COMPILER V9.01   I2C                                                                   12/07/2023 07:54:50 PAGE 3   

 118          * 输入           : 无
 119          * 输出           : 无
 120          * 备注           : 接收完一个字节SCL=0
 121          *******************************************************************************/
 122          //void I2cReadRespon()
 123          //{
 124          //      SDA=0;
 125          //      Delay10us();
 126          //      SDA=1;
 127          //      Delay10us();
 128          //}


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    142    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
